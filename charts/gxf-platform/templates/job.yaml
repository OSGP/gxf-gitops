{{- range $job := .Values.platform.jobs -}}
{{- $name := $job.name }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $name }}
spec:
  template:
    spec:
      containers:
        - name: {{ $name }}
          image: {{ $job.imageRepository | default $.Values.platform.imageRepository | default "ghcr.io/osgp/" }}{{ $name }}:{{ $job.imageTag | default $.Values.platform.imageTag | default "latest" }}
          imagePullPolicy: {{ $job.imagePullPolicy | default $.Values.platform.imagePullPolicy | default "Always" }}
          env:
            - name: JAVA_OPTS
              value: "-XX:MaxRAMPercentage=80.0 -XX:InitialRAMPercentage=80.0"
            - name: ACTIVEMQ_JMS_CLIENT_KEYSTORE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: activemq-jms-client-certs
                  key: keyStorePassword
            - name: ACTIVEMQ_JMS_CLIENT_TRUSTSTORE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: activemq-jms-client-certs
                  key: trustStorePassword
          startupProbe:
            {{- if $job.startupProbe }}
              {{- toYaml $job.startupProbe | nindent 12 }}
            {{- else if $.Values.platform.startupProbe}}
              {{- toYaml $.Values.platform.startupProbe | nindent 12 }}
            {{- else }}
            failureThreshold: 30
            periodSeconds: 5
            httpGet:
              port: 8080
              path: /probe/probe.txt
            {{- end }}
          livenessProbe:
            {{- if $job.livenessProbe }}
              {{- toYaml $job.livenessProbe | nindent 12 }}
            {{- else if $.Values.platform.livenessProbe}}
              {{- toYaml $.Values.platform.livenessProbe | nindent 12 }}
            {{- else }}
            failureThreshold: 12
            periodSeconds: 5
            timeoutSeconds: 5
            httpGet:
              port: 9404
              path: /metrics
            {{- end }}
          readinessProbe:
            {{- if $job.readinessProbe }}
              {{- toYaml $job.readinessProbe | nindent 12 }}
            {{- else if $.Values.platform.readinessProbe}}
              {{- toYaml $.Values.platform.readinessProbe | nindent 12 }}
            {{- else }}
            failureThreshold: 6
            periodSeconds: 5
            timeoutSeconds: 5
            httpGet:
              port: 9404
              path: /metrics
            {{- end }}
          volumeMounts:
            - name: gxf-platform-config
              mountPath: /etc/osp/global.properties
              subPath: global.properties
            - name: gxf-platform-config
              mountPath: /etc/osp/{{ $name }}.properties
              subPath: global.properties
            - name: activemq-secrets
              mountPath: /etc/ssl/certs/jms/gxf-platform/
            - name: oslp-signing-keys
              mountPath: /etc/ssl/certs/oslp
            - name: report-volume
              mountPath: /target/output
      volumes:
        - name: gxf-platform-config
          configMap:
            name: gxf-platform-config
        - name: activemq-secrets
          secret:
            secretName: activemq-jms-client-certs
        - name: oslp-signing-keys
          secret:
            secretName: oslp-signing-keys
        - name: report-volume
          persistentVolumeClaim:
            claimName: report-volume
      restartPolicy: Never
{{- end }}